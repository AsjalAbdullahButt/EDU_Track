<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Enrollment Records</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="/static/CSS/main.css">
    <link rel="stylesheet" href="/static/CSS/dashboards.css">
    <style>
        .page-layout { display: flex; min-height: 100vh; }
        .main-content { flex: 1; padding: 20px; background: #f5f5f5; }
        .stats-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin: 20px 0; }
        .stat-card { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .stat-card h3 { margin: 0 0 10px 0; font-size: 14px; color: #666; }
        .stat-card .value { font-size: 32px; font-weight: bold; color: #1976d2; }
        .table-container { background: white; padding: 20px; border-radius: 8px; margin-top: 20px; }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #ddd; }
        th { background: #1976d2; color: white; font-weight: 600; }
        tbody tr:hover { background: #f5f5f5; }
        .status-badge { padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: 600; }
        .status-active { background: #4caf50; color: white; }
        .loading { text-align: center; padding: 40px; color: #999; }
        .error { color: #f44336; padding: 20px; text-align: center; }
        .btn { padding: 8px 16px; border: none; border-radius: 4px; cursor: pointer; margin: 5px; }
        .btn-primary { background: #1976d2; color: white; }
        .btn-success { background: #4caf50; color: white; }
        .btn-danger { background: #f44336; color: white; }
    </style>
</head>
<body>
    <div class="page-layout">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="logo-section">
                <img src="/static/Images/EDU-Logo.png" alt="Logo" class="sidebar-logo">
                <h2 class="sidebar-title">EDU Track</h2>
            </div>
            <nav class="nav-links">
                <a href="/pages/dashboard/admin/dashboard_admin.html" class="nav-link">Dashboard</a>
                <a href="/pages/dashboard/admin/admin_user_management.html" class="nav-link">User Management</a>
                <a href="/pages/dashboard/admin/admin_course_approvals.html" class="nav-link">Course Approvals</a>
                <a href="/pages/dashboard/admin/fee_records.html" class="nav-link">Fee Records</a>
                <a href="/pages/dashboard/admin/fee_verification.html" class="nav-link">Fee Verification</a>
                <a href="/pages/dashboard/admin/salary_payments.html" class="nav-link">Salary Payments</a>
                <a href="/pages/dashboard/admin/admin_security.html" class="nav-link">Security Settings</a>
                <a href="/pages/dashboard/admin/admin_records_new.html" class="nav-link active">Records</a>
            </nav>
            <div class="logout-section">
                <button class="btn btn-danger" onclick="logout()">Logout</button>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <h1><i class="fas fa-table"></i> Enrollment Records</h1>
            
            <div class="stats-grid">
                <div class="stat-card">
                    <h3>Total Enrollments</h3>
                    <div class="value" id="totalEnrollments">0</div>
                </div>
                <div class="stat-card">
                    <h3>Active Students</h3>
                    <div class="value" id="activeStudents">0</div>
                </div>
                <div class="stat-card">
                    <h3>Total Students</h3>
                    <div class="value" id="totalStudents">0</div>
                </div>
                <div class="stat-card">
                    <h3>Total Courses</h3>
                    <div class="value" id="totalCourses">0</div>
                </div>
            </div>

            <div class="table-container">
                <div style="margin-bottom: 15px;">
                    <button class="btn btn-primary" onclick="loadData()">
                        <i class="fas fa-sync"></i> Refresh Data
                    </button>
                    <button class="btn btn-success" onclick="exportData()">
                        <i class="fas fa-download"></i> Export CSV
                    </button>
                </div>

                <table id="enrollmentTable">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>Student ID</th>
                            <th>Student Name</th>
                            <th>Course ID</th>
                            <th>Course Name</th>
                            <th>Semester</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody">
                        <tr><td colspan="7" class="loading">Loading data...</td></tr>
                    </tbody>
                </table>
            </div>
        </main>
    </div>

    <script>
        const API_BASE = 'http://127.0.0.1:8000';
        let enrollments = [];
        let students = [];
        let courses = [];

        async function loadData() {
            console.log('Loading data...');
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = '<tr><td colspan="7" class="loading">Loading data...</td></tr>';

            try {
                // Fetch all data
                const [enrollRes, studentRes, courseRes] = await Promise.all([
                    fetch(`${API_BASE}/enrollments/`),
                    fetch(`${API_BASE}/students/`),
                    fetch(`${API_BASE}/courses/`)
                ]);

                enrollments = await enrollRes.json();
                students = await studentRes.json();
                courses = await courseRes.json();

                console.log('Data loaded:', {
                    enrollments: enrollments.length,
                    students: students.length,
                    courses: courses.length
                });

                // Update stats
                document.getElementById('totalEnrollments').textContent = enrollments.length;
                document.getElementById('totalStudents').textContent = students.length;
                document.getElementById('totalCourses').textContent = courses.length;
                
                const activeStudentIds = new Set(
                    enrollments
                        .filter(e => (e.status || 'Active').toLowerCase() === 'active')
                        .map(e => e.student_id)
                );
                document.getElementById('activeStudents').textContent = activeStudentIds.size;

                // Render table
                renderTable();

            } catch (error) {
                console.error('Error loading data:', error);
                tbody.innerHTML = `<tr><td colspan="7" class="error">Error: ${error.message}</td></tr>`;
            }
        }

        function renderTable() {
            const tbody = document.getElementById('tableBody');
            
            if (enrollments.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align:center; padding:40px; color:#999;">No enrollment records found</td></tr>';
                return;
            }

            tbody.innerHTML = enrollments.map((enrollment, index) => {
                const student = students.find(s => s.student_id === enrollment.student_id);
                const course = courses.find(c => c.course_id === enrollment.course_id);
                
                const studentName = student?.full_name || 'Unknown';
                const courseName = course?.course_name || 'Unknown';
                const status = enrollment.status || 'Active';

                return `
                    <tr>
                        <td>${index + 1}</td>
                        <td>${enrollment.student_id}</td>
                        <td>${studentName}</td>
                        <td>${enrollment.course_id}</td>
                        <td>${courseName}</td>
                        <td>${enrollment.semester || 'N/A'}</td>
                        <td><span class="status-badge status-active">${status}</span></td>
                    </tr>
                `;
            }).join('');
        }

        function exportData() {
            if (enrollments.length === 0) {
                alert('No data to export');
                return;
            }

            const headers = ['#', 'Student ID', 'Student Name', 'Course ID', 'Course Name', 'Semester', 'Status'];
            const rows = enrollments.map((e, index) => {
                const student = students.find(s => s.student_id === e.student_id);
                const course = courses.find(c => c.course_id === e.course_id);
                return [
                    index + 1,
                    e.student_id,
                    student?.full_name || 'Unknown',
                    e.course_id,
                    course?.course_name || 'Unknown',
                    e.semester || 'N/A',
                    e.status || 'Active'
                ];
            });

            const csv = [headers, ...rows].map(row => row.join(',')).join('\n');
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'enrollment_records.csv';
            a.click();
            URL.revokeObjectURL(url);
        }

        function logout() {
            if (confirm('Are you sure you want to logout?')) {
                localStorage.clear();
                sessionStorage.clear();
                window.location.href = '/';
            }
        }

        // Load data on page load
        window.addEventListener('DOMContentLoaded', loadData);
    </script>
</body>
</html>
