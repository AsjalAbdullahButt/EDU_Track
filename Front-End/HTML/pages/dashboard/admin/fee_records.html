<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>EDU Track - Fee Records</title>
  <link rel="stylesheet" href="/static/CSS/main.css">
  <link rel="stylesheet" href="/static/CSS/dashboards.css">
  <link rel="stylesheet" href="/static/CSS/fee_records.css">
</head>
<body>
  <div class="layout-wrapper">
    <script src="/static/JS/fee_records.js" defer></script>
    <script src="/static/JS/dashboard.js" defer></script>
              <th>Amount</th>
              <th>Status</th>
            </tr>
          </thead>
          <tbody id="feeList">
            <!-- Fee records populated here -->
          </tbody>
        </table>
      </section>
    </main>
  </div>

  <script>
    let feeData = [];
    let studentsMap = {};

    function monthName(dateStr){
      if(!dateStr) return '';
      const d = new Date(dateStr);
      return d.toLocaleString(undefined, { month: 'long' });
    }

    function renderFees(list){
      const tbody = document.getElementById('feeList');
      tbody.innerHTML = '';
      list.forEach(f => {
        const name = studentsMap[f.student_id] || `#${f.student_id}`;
        const month = monthName(f.due_date);
        const status = f.status || ( (Number(f.amount_paid||0) >= Number(f.total_amount||0)) ? 'Paid' : 'Missing');
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${f.student_id}</td>
          <td>${name}</td>
          <td>${f.department || ''}</td>
          <td>${month}</td>
          <td>${f.total_amount}</td>
          <td class="status-${status.toLowerCase()}">${status}</td>
        `;
        tbody.appendChild(tr);
      });
    }

    function applyFilters(){
      const nameFilter = document.getElementById('filterName').value.toLowerCase();
      const dept = document.getElementById('filterDepartment').value;
      const month = document.getElementById('filterMonth').value;
      const status = document.getElementById('filterStatus').value;

      const filtered = feeData.filter(f=>{
        const name = (studentsMap[f.student_id]||'').toLowerCase();
        const m = monthName(f.due_date);
        const st = f.status || ( (Number(f.amount_paid||0) >= Number(f.total_amount||0)) ? 'Paid' : 'Missing');
        return (!nameFilter || name.includes(nameFilter)) &&
               (!dept || (f.department||'') === dept) &&
               (!month || m === month) &&
               (!status || st === status);
      });
      renderFees(filtered);
    }

    async function init(){
      try{
        const [fees, students] = await Promise.all([
          fetch('/fees').then(r=>r.ok?r.json():[]).catch(()=>[]),
          fetch('/students').then(r=>r.ok?r.json():[]).catch(()=>[])
        ]);
        feeData = fees || [];
        studentsMap = Object.fromEntries((students||[]).map(s=>[s.student_id, s.full_name]));
        renderFees(feeData);
      }catch(e){ console.error('Failed to load fees', e); }
    }

    window.applyFilters = applyFilters;
    window.onload = init;
  </script>

  <script src="/static/JS/dashboard.js" defer></script>
</body>
</html>
